services:
    app:
        build:
            context: .
            dockerfile: Dockerfile
        ports:
            - '${APP_PORT:-8080}:8080'
        environment:
            PORT: 8080
            APP_NAME: '${APP_NAME:-Laravel}'
            APP_ENV: local
            APP_KEY: '${APP_KEY}'
            APP_DEBUG: 'true'
            APP_URL: 'http://localhost:${APP_PORT:-8080}'
            LOG_CHANNEL: stderr
            DB_CONNECTION: pgsql
            DB_HOST: postgres
            DB_PORT: 5432
            DB_DATABASE: '${DB_DATABASE:-laravel}'
            DB_USERNAME: '${DB_USERNAME:-laravel}'
            DB_PASSWORD: '${DB_PASSWORD:-password}'
            REDIS_CLIENT: phpredis
            REDIS_HOST: redis
            REDIS_PORT: 6379
            CACHE_STORE: redis
            SESSION_DRIVER: redis
            QUEUE_CONNECTION: redis
            RUN_MIGRATIONS: 'true'
        depends_on:
            postgres:
                condition: service_healthy
            redis:
                condition: service_healthy
        networks:
            - app

    worker:
        build:
            context: .
            dockerfile: Dockerfile
        command: php artisan queue:work redis --sleep=3 --tries=3 --max-time=3600
        environment:
            APP_NAME: '${APP_NAME:-Laravel}'
            APP_ENV: local
            APP_KEY: '${APP_KEY}'
            APP_DEBUG: 'true'
            APP_URL: 'http://localhost:${APP_PORT:-8080}'
            LOG_CHANNEL: stderr
            DB_CONNECTION: pgsql
            DB_HOST: postgres
            DB_PORT: 5432
            DB_DATABASE: '${DB_DATABASE:-laravel}'
            DB_USERNAME: '${DB_USERNAME:-laravel}'
            DB_PASSWORD: '${DB_PASSWORD:-password}'
            REDIS_CLIENT: phpredis
            REDIS_HOST: redis
            REDIS_PORT: 6379
            CACHE_STORE: redis
            QUEUE_CONNECTION: redis
        depends_on:
            app:
                condition: service_started
        networks:
            - app

    postgres:
        image: 'postgres:17-alpine'
        ports:
            - '${FORWARD_DB_PORT:-5432}:5432'
        environment:
            POSTGRES_DB: '${DB_DATABASE:-laravel}'
            POSTGRES_USER: '${DB_USERNAME:-laravel}'
            POSTGRES_PASSWORD: '${DB_PASSWORD:-password}'
        volumes:
            - 'app-postgres:/var/lib/postgresql/data'
        networks:
            - app
        healthcheck:
            test: ['CMD-SHELL', 'pg_isready -U ${DB_USERNAME:-laravel}']
            interval: 5s
            retries: 3
            timeout: 5s

    redis:
        image: 'redis:7-alpine'
        ports:
            - '${FORWARD_REDIS_PORT:-6379}:6379'
        volumes:
            - 'app-redis:/data'
        networks:
            - app
        healthcheck:
            test: ['CMD', 'redis-cli', 'ping']
            interval: 5s
            retries: 3
            timeout: 5s

networks:
    app:
        driver: bridge

volumes:
    app-postgres:
        driver: local
    app-redis:
        driver: local
